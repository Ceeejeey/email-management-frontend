name: Frontend CI/CD

on:
  push:
    branches:
      - main

jobs:
  ci:
    name: Run CI checks
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm install

      # Step 4: Lint (optional but recommended)
      - name: Run linter
        run: npm run lint --if-present

      # Step 5: Build React app
      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: npm run build

  cd:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: ci   # <-- CD only runs if CI passes

    steps:
      # Step 1 — Checkout Code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2 — Authenticate with Google Cloud
      - name: Google Cloud Authentication
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Step 3 — Set GCP Project
      - name: Set Project
        run: gcloud config set project email-management-449416

      # Step 4 — Configure Docker for Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker asia-south1-docker.pkg.dev

      # Step 5 — Build Docker Image
      - name: Build Docker image
        run: |
          docker build -t asia-south1-docker.pkg.dev/email-management-449416/email-frontend-repo/email-frontend:latest .

      # Step 6 — Push Docker Image
      - name: Push Docker image
        run: |
          docker push asia-south1-docker.pkg.dev/email-management-449416/email-frontend-repo/email-frontend:latest

      # Step 7 — Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy email-frontend \
            --image=asia-south1-docker.pkg.dev/email-management-449416/email-frontend-repo/email-frontend:latest \
            --platform=managed \
            --region=asia-south1 \
            --allow-unauthenticated \
            --port=80 \
            --service-account=767837784755-compute@developer.gserviceaccount.com \
            --set-env-vars VITE_API_URL=${{ secrets.VITE_API_URL }}
